name: .NET Debug Build and Test

on:
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    env:
      Solution_Name: Xcaciv.Command.sln
      Nuget_Config_Path: NuGet.config
      Artifact_Directory: ${{ github.workspace }}\artifacts\packages
      UseNet08Property: -p:UseNet08=true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            10.0.x

      - name: Configure Nuget Source - remove
        continue-on-error: true
        run: |
          dotnet nuget remove source local

      - name: Configure Nuget Source - update
        run: |
          dotnet nuget update source github -s "https://nuget.pkg.github.com/xcaciv/index.json" -u xcaciv -p ${{ secrets.NUGET_PAT }} --store-password-in-clear-text --configfile $env:Nuget_Config_Path

      - name: Restore dependencies
        run: dotnet restore $env:Solution_Name --configfile $env:Nuget_Config_Path

      - name: Debug Build
        run: dotnet build $env:Solution_Name --configuration Debug --configfile $env:Nuget_Config_Path

      - name: Test with dotnet
        run: dotnet test $env:Solution_Name --no-build --logger trx --results-directory "TestResults"

      - name: Upload dotnet test results
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-results
          path: TestResults

      - name: Prepare artifacts directory and local source
        run: |
          New-Item -ItemType Directory -Path $env:Artifact_Directory -Force | Out-Null
          dotnet nuget add source "$env:Artifact_Directory" --name local-artifacts --configfile $env:Nuget_Config_Path
          dotnet nuget locals global-packages --clear

      - name: Build Interface (Release)
        run: dotnet build src\Xcaciv.Command.Interface\Xcaciv.Command.Interface.csproj --configuration Release $env:UseNet08Property

      - name: Pack Interface (Release)
        run: dotnet pack src\Xcaciv.Command.Interface\Xcaciv.Command.Interface.csproj --configuration Release --no-build --output "$env:Artifact_Directory" $env:UseNet08Property

      - name: Restore Core against local Interface
        run: dotnet restore src\Xcaciv.Command.Core\Xcaciv.Command.Core.csproj --configfile $env:Nuget_Config_Path --source "$env:Artifact_Directory" --source "https://api.nuget.org/v3/index.json" --source "https://nuget.pkg.github.com/xcaciv/index.json"

      - name: Build Core (Release)
        run: dotnet build src\Xcaciv.Command.Core\Xcaciv.Command.Core.csproj --configuration Release --no-restore $env:UseNet08Property

      - name: Pack Core (Release)
        run: dotnet pack src\Xcaciv.Command.Core\Xcaciv.Command.Core.csproj --configuration Release --no-build --output "$env:Artifact_Directory" $env:UseNet08Property

      - name: Restore FileLoader against local packages
        run: dotnet restore src\Xcaciv.Command.FileLoader\Xcaciv.Command.FileLoader.csproj --configfile $env:Nuget_Config_Path --source "$env:Artifact_Directory" --source "https://api.nuget.org/v3/index.json" --source "https://nuget.pkg.github.com/xcaciv/index.json"

      - name: Build FileLoader (Release)
        run: dotnet build src\Xcaciv.Command.FileLoader\Xcaciv.Command.FileLoader.csproj --configuration Release --no-restore $env:UseNet08Property

      - name: Pack FileLoader (Release)
        run: dotnet pack src\Xcaciv.Command.FileLoader\Xcaciv.Command.FileLoader.csproj --configuration Release --no-build --output "$env:Artifact_Directory" $env:UseNet08Property

      - name: Restore Command against local packages
        run: dotnet restore src\Xcaciv.Command\Xcaciv.Command.csproj --configfile $env:Nuget_Config_Path --source "$env:Artifact_Directory" --source "https://api.nuget.org/v3/index.json" --source "https://nuget.pkg.github.com/xcaciv/index.json"

      - name: Build Command (Release)
        run: dotnet build src\Xcaciv.Command\Xcaciv.Command.csproj --configuration Release --no-restore $env:UseNet08Property

      - name: Pack Command (Release)
        run: dotnet pack src\Xcaciv.Command\Xcaciv.Command.csproj --configuration Release --no-build --output "$env:Artifact_Directory" $env:UseNet08Property

      - name: Restore DependencyInjection against local packages
        run: dotnet restore src\Xcaciv.Command.DependencyInjection\Xcaciv.Command.DependencyInjection.csproj --configfile $env:Nuget_Config_Path --source "$env:Artifact_Directory" --source "https://api.nuget.org/v3/index.json" --source "https://nuget.pkg.github.com/xcaciv/index.json"

      - name: Build DependencyInjection (Release)
        run: dotnet build src\Xcaciv.Command.DependencyInjection\Xcaciv.Command.DependencyInjection.csproj --configuration Release --no-restore $env:UseNet08Property

      - name: Pack DependencyInjection (Release)
        run: dotnet pack src\Xcaciv.Command.DependencyInjection\Xcaciv.Command.DependencyInjection.csproj --configuration Release --no-build --output "$env:Artifact_Directory" $env:UseNet08Property

      - name: Restore Extensions.Commandline against local packages
        run: dotnet restore src\Xcaciv.Command.Extensions.Commandline\Xcaciv.Command.Extensions.Commandline.csproj --configfile $env:Nuget_Config_Path --source "$env:Artifact_Directory" --source "https://api.nuget.org/v3/index.json" --source "https://nuget.pkg.github.com/xcaciv/index.json"

      - name: Build Extensions.Commandline (Release)
        run: dotnet build src\Xcaciv.Command.Extensions.Commandline\Xcaciv.Command.Extensions.Commandline.csproj --configuration Release --no-restore $env:UseNet08Property

      - name: Pack Extensions.Commandline (Release)
        run: dotnet pack src\Xcaciv.Command.Extensions.Commandline\Xcaciv.Command.Extensions.Commandline.csproj --configuration Release --no-build --output "$env:Artifact_Directory" $env:UseNet08Property